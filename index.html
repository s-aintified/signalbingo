<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>LOW SIGNAL â€” Thread Bingo</title>
<style>
  :root{
    --bg:#0f1115;
    --card:#161a20;
    --ink:#cfd6e1;
    --muted:#9aa3b2;
    --accent1:#5078D2;
    --accent2:#F58264;
    --accent3:#FFD787;
    --success:#6dd5a1;
    --danger:#d85a5a;
    --line:rgba(255,255,255,.06);
    --win:#7fffd4; /* neon aqua for bingo squares */
  }

  html,body{
    margin:0;
    padding:0;
    background:#0b0d11;
    color:var(--ink);
    font:15px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial;
    height:100%;
    overflow:hidden; /* no inner scroll; JCink controls page scroll */
  }

  .ls-wrap{
    max-width:1100px;
    margin:24px auto;
    padding:24px;
    background:var(--bg);
    border-radius:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.4);
  }

  .ls-logo{
    font-size:34px;
    font-weight:900;
    text-transform:uppercase;
    margin:0 0 6px;
    background:linear-gradient(90deg,var(--accent1),var(--accent2),var(--accent3));
    -webkit-background-clip:text;
    background-clip:text;
    color:transparent;
    text-align:center;
  }

  .ls-sub{
    font-size:13px;
    color:var(--muted);
    margin-bottom:10px;
    text-align:center;
  }

  .ls-controls{
    margin-top:16px;
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:center;
  }

  .ls-input,.ls-select{
    background:#10151c;
    border:1px solid var(--line);
    border-radius:10px;
    padding:8px 10px;
    color:var(--ink);
    min-width:180px;
    font-size:13px;
  }

  .ls-btn{
    background:#1e232b;
    border:0;
    color:var(--ink);
    padding:8px 12px;
    border-radius:10px;
    cursor:pointer;
    font-size:12px;
  }
  .ls-btn:hover{filter:brightness(1.1);}
  .ls-btn.save{
    background:#212733;
    font-weight:700;
    box-shadow:0 6px 18px rgba(0,0,0,.35);
  }

  .ls-legend{
    font-size:13px;
    color:var(--muted);
    margin:14px auto 18px;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid var(--line);
    background:#10141b;
    max-width:680px;
    text-align:center;
  }

  .ls-status{
    font-size:13px;
    text-transform:uppercase;
    letter-spacing:.12em;
    color:var(--muted);
    margin:12px 0;
    text-align:center;
  }
  .ls-status.is-bingo{
    color:var(--win);
    font-weight:700;
  }

  .ls-grid{
    position:relative;
    display:grid;
    grid-template-columns:repeat(5,1fr);
    gap:16px;
    padding:18px;
    border-radius:16px;
    background:#0c0f14;
    box-shadow:0 0 0 1px rgba(255,255,255,.03);
    margin:0 auto;
    max-width:1000px;
    width:100%;
  }
  .ls-grid::before{
    content:"";
    position:absolute;
    inset:-4px;
    border-radius:18px;
    padding:4px;
    background:linear-gradient(90deg,var(--accent1),var(--accent2),var(--accent3));
    -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
    -webkit-mask-composite:xor;
    mask-composite:exclude;
    opacity:.6;
    filter:blur(.7px);
    pointer-events:none;
  }

  .ls-cell{
    position:relative;
    aspect-ratio:1/1;
    border-radius:14px;
    background:#151a21;
    border:2px solid var(--line);
    overflow:hidden;
    cursor:pointer;
    transition:border-color .16s,box-shadow .16s,transform .08s;
  }
  .ls-cell:hover{
    transform:translateY(-1px);
  }

  .ls-cell::before{
    content:"";
    position:absolute;
    inset:-3px;
    border-radius:14px;
    padding:3px;
    background:linear-gradient(90deg,var(--accent1),var(--accent2),var(--accent3));
    -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
    -webkit-mask-composite:xor;
    mask-composite:exclude;
    opacity:.45;
    filter:blur(.4px);
    pointer-events:none;
  }
  .ls-cell.is-done::before{
    opacity:.75;
    filter:blur(.7px);
  }

  /* BINGO squares extra highlight */
  .ls-cell.win{
    border-color:var(--win);
    box-shadow:
      0 0 20px rgba(127,255,212,.75),
      inset 0 0 16px rgba(127,255,212,.7);
  }
  .ls-cell.win::before{
    background:var(--win);
    opacity:.95;
    filter:blur(.7px);
  }

  .ls-img{
    position:absolute;
    inset:0;
    background-size:cover;
    background-position:center;
    opacity:.9;
  }
  .ls-shade{
    position:absolute;
    inset:0;
    background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(0,0,0,.55));
  }
  .ls-text{
    position:absolute;
    left:10px;
    right:10px;
    bottom:40px;
    font-size:14px;
    color:#f5f6fb;
    text-shadow:0 1px 2px rgba(0,0,0,.7);
  }
  .ls-link{
    position:absolute;
    left:10px;
    right:10px;
    bottom:10px;
    font-size:12px;
    color:#b8c8ff;
    text-decoration:underline;
    overflow:hidden;
    white-space:nowrap;
    text-overflow:ellipsis;
  }
  .ls-badge{
    position:absolute;
    top:8px;
    left:8px;
    padding:4px 8px;
    font-size:11px;
    border-radius:8px;
    background:rgba(0,0,0,.65);
    color:#fff;
  }
  .ls-done{
    position:absolute;
    inset:0;
    display:grid;
    place-items:center;
    background:rgba(0,0,0,.35);
    opacity:0;
    transition:opacity .16s;
  }
  .ls-cell.is-done .ls-done{opacity:1;}
  .ls-check{
    font-size:30px;
    color:var(--success);
    text-shadow:0 0 12px rgba(109,213,161,.5);
  }

  /* tooltip bubble inside each cell */
  .ls-tip{
    position:absolute;
    left:10px;
    right:10px;
    top:30px;
    padding:6px 7px;
    font-size:11px;
    line-height:1.4;
    background:rgba(3,6,12,.92);
    border-radius:8px;
    border:1px solid rgba(255,255,255,.08);
    color:#e5e9f5;
    opacity:0;
    transform:translateY(-4px);
    pointer-events:none;
    transition:opacity .15s ease, transform .15s ease;
    z-index:5;
  }
  .ls-cell:hover .ls-tip{
    opacity:1;
    transform:translateY(0);
  }

  /* Modal */
  .ls-modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.55);
    display:none;
    place-items:center;
    z-index:9999;
  }
  .ls-modal.show{display:grid;}
  .ls-card{
    width:min(520px,90vw);
    background:var(--card);
    border-radius:14px;
    border:1px solid var(--line);
    padding:18px;
    box-shadow:0 20px 50px rgba(0,0,0,.7);
  }
  .ls-card h3{margin:0 0 10px;font-size:16px;}
  .ls-row{display:flex;gap:10px;margin-bottom:10px;}
  .ls-row>*{flex:1;}
  .ls-mini{font-size:11px;padding:7px 9px;border-radius:8px;}
  .ls-danger{background:linear-gradient(90deg,#6b2a2a,#d85a5a);color:#fff;}
  .ls-success{background:linear-gradient(90deg,#2b694a,#6dd5a1);color:#000;}

  /* Confetti layer */
  .ls-confetti{
    position:fixed;
    inset:0;
    pointer-events:none;
    overflow:hidden;
    z-index:9998;
  }
  .ls-piece{
    position:absolute;
    width:8px;
    height:14px;
    border-radius:2px;
    opacity:.9;
    animation:ls-confetti-fall linear forwards;
  }
  @keyframes ls-confetti-fall{
    0%{
      transform:translate3d(var(--x,0),-10%,0) rotate(0deg);
    }
    100%{
      transform:translate3d(var(--x,0),110%,0) rotate(360deg);
    }
  }

  @media (max-width:700px){
    .ls-grid{
      max-width:100%;
      gap:10px;
      padding:12px;
    }
    .ls-text{font-size:13px;}
  }
</style>
</head>
<body>

<div class="ls-wrap" id="bingoApp">
  <h1 class="ls-logo">LOW SIGNAL</h1>
  <div class="ls-sub">
    click a square to edit â€¢ use the checkbox to mark it complete â€¢ center is always free
  </div>

  <div class="ls-controls">
    <input class="ls-input" id="profileId" placeholder="profile id (e.g. yana-main / character)">
    <select class="ls-select" id="profilesList"></select>
    <button class="ls-btn" id="loadProfile">load</button>
    <button class="ls-btn" id="deleteProfile">delete</button>
    <button class="ls-btn save" id="saveProfile">save</button>
    <button class="ls-btn" id="randomizeBoard">randomize</button>
    <button class="ls-btn" id="resetBoard">reset</button>
  </div>

  <div class="ls-legend">
    Add a thread link + optional image per square. When you get 5 completed squares in a row
    (row, column, or diagonal), those squares will glow neon â€” screenshot your card to redeem points.
  </div>

  <div class="ls-status" id="status">no bingo yet</div>

  <div class="ls-grid" id="grid"></div>
</div>

<div class="ls-confetti" id="confetti"></div>

<!-- modal -->
<div class="ls-modal" id="modal">
  <div class="ls-card">
    <h3>Edit square</h3>
    <div class="ls-row">
      <input class="ls-input" id="promptInput" disabled>
    </div>
    <div class="ls-row">
      <input class="ls-input" id="urlThread" placeholder="thread link (URL)">
    </div>
    <div class="ls-row">
      <input class="ls-input" id="urlImage" placeholder="image URL (optional)">
      <input type="file" class="ls-input" id="fileImage" accept="image/*">
    </div>
    <label style="font-size:12px;">
      <input type="checkbox" id="doneChk"> mark this square complete
    </label>
    <div class="ls-row" style="justify-content:flex-end;margin-top:12px;">
      <button class="ls-btn ls-mini ls-danger" id="clearImage">remove image</button>
      <button class="ls-btn ls-mini" id="closeModal">close</button>
      <button class="ls-btn ls-mini ls-success" id="saveSquare">save</button>
    </div>
  </div>
</div>

<script>
/* ===== THEME BY MEMBERGROUP/URL ===== */
(function(){
  const THEMES={
    'g-2':['#5078D2','#F58264','#FFD787'],     // Guest
    'g-4':['#8A5A16','#DFA546','#F8CC76'],     // Staff
    'g-6':['#A13D5B','#E8718A','#FFA0B2'],     // Romance
    'g-7':['#161B2E','#353E58','#616B89'],     // Mystery
    'g-8':['#3D338D','#7362E8','#9D8FF'],     // Fantasy (small fix if needed)
    'g-9':['#823424','#BF5C40','#E89A65'],     // Drama
    'g-10':['#00666D','#289DA5','#5AD2DC'],    // Sci-Fi
    'g-11':['#360000','#760A0A','#AA2727'],    // Horror
    'g-12':['#BEAF96','#E6DCC8','#FFFBEF'],    // Comedy
    'g-13':['#856CB6','#C1AAE8','#DFD0FC'],    // Tragedy
    'g-14':['#78645A','#AA917D','#E1CDB9'],    // Slice of Life
    'g-16':['#683616','#B55F2B','#E89952']     // Thriller
  };
  const params=new URLSearchParams(location.search);
  const urlKey=params.get('theme');
  const bodyKey=[...document.body.classList].find(c=>THEMES[c]);
  const key=(urlKey && THEMES[urlKey]) ? urlKey : (bodyKey || 'g-2');
  const [a,b,c]=THEMES[key];
  document.documentElement.style.setProperty('--accent1',a);
  document.documentElement.style.setProperty('--accent2',b);
  document.documentElement.style.setProperty('--accent3',c);
})();

/* ===== BINGO LOGIC + CONFETTI + SOUND ===== */
(() => {
  const SIZE = 5;
  const MID  = 12;
  const PREFIX = 'lowSignalBingo_v11_';

  /* master prompt pool with emojis + descriptions */
  const promptPool = [
    /* ORIGINAL PROMPTS */
    { text:"public argument",        emoji:"ðŸ’¥", desc:"two characters argue in public where others can see or overhear" },
    { text:"first kiss (or almost)", emoji:"ðŸ’‹", desc:"a first kiss finally happens â€” or almost does and gets interrupted" },
    { text:"broken phone",          emoji:"ðŸ“±ðŸ’”", desc:"a phone breaks, gets lost, or ruins communication at the worst time" },
    { text:"rain confession",       emoji:"ðŸŒ§ï¸", desc:"someone confesses something big in the rain or bad weather" },
    { text:"caught lying",          emoji:"ðŸ¤¥", desc:"a character is caught in a lie â€” big or small, but it matters" },
    { text:"fake apology",          emoji:"ðŸ™ƒ", desc:"â€œsorryâ€ is said, but itâ€™s clearly not genuine" },
    { text:"late-night drive",      emoji:"ðŸŒ™ðŸš—", desc:"characters share a late-night car ride that changes the vibe" },
    { text:"crime of opportunity",  emoji:"ðŸ§¤", desc:"someone does something shady or illegal simply because they can" },
    { text:"soft domestic",         emoji:"ðŸ«§", desc:"quiet, everyday intimacy â€” cooking, cleaning, sleepover, etc." },
    { text:"unexpected softness",   emoji:"ðŸ©¹", desc:"a usually guarded character shows a surprisingly gentle side" },
    { text:"wrong person saw",      emoji:"ðŸ‘€", desc:"someone sees something they were never meant to witness" },
    { text:"rivals to allies",      emoji:"âš”ï¸ðŸ¤", desc:"two characters who usually clash end up on the same side" },
    { text:"free space",            emoji:"â­",  desc:"automatic free space â€” counts as already complete" },
    { text:"stolen glance",         emoji:"ðŸ‘ï¸", desc:"someone gets caught staring a little too long" },
    { text:"self-sabotage",         emoji:"ðŸ§¨", desc:"a character ruins their own chances out of fear or habit" },
    { text:"petty revenge",         emoji:"ðŸ˜ˆ", desc:"someone gets even in a small, deliciously petty way" },
    { text:"drunk honesty",         emoji:"ðŸ·", desc:"alcohol or altered state leads to a little too much truth" },
    { text:"found footage",         emoji:"ðŸŽ¥", desc:"evidence appears in the form of photos, videos, or recordings" },
    { text:"unreliable narration",  emoji:"ðŸ““", desc:"a scene shows someone misremembering, lying, or skewing reality" },
    { text:"secret exposed",        emoji:"ðŸ«¢", desc:"a secret finally comes out â€” on purpose or by accident" },
    { text:"we shouldn't be here",  emoji:"ðŸš«", desc:"characters are somewhere they know they shouldnâ€™t be" },
    { text:"left on read",          emoji:"ðŸ“µ", desc:"a text/DM is seen but ignored long enough to sting" },
    { text:"make a wish",           emoji:"âœ¨", desc:"someone makes a wish â€” birthday, coin toss, ritual, etc." },
    { text:"messy meet-cute",       emoji:"â˜•", desc:"a first meeting thatâ€™s cute but also chaotic or embarrassing" },
    { text:"burn it down",          emoji:"ðŸ”¥", desc:"a character destroys something important â€” literally or metaphorically" },

    /* EMOTION PROMPTS (KEPT ONES) */
    { text:"heart in throat",              emoji:"ðŸ’“", desc:"visible anxiety or nerves â€” shaking hands, voice cracks, fidgeting" },
    { text:"ugly cry unlocked",            emoji:"ðŸ˜­", desc:"full, unpretty, uncontrollable crying in front of someone" },
    { text:"laughing instead of breaking", emoji:"ðŸ˜‚ðŸ¥²", desc:"joking or laughing to avoid crying, spiraling, or panicking" },
    { text:"you weren't supposed to see that", emoji:"ðŸš«ðŸ‘€", desc:"someone witnesses a rock-bottom or deeply private moment" },
    { text:"i didnâ€™t mean that",           emoji:"ðŸ«¢", desc:"harsh words said in anger are instantly regretted" },
    { text:"too tired to fight",           emoji:"ðŸ˜®â€ðŸ’¨", desc:"the character emotionally checks out instead of arguing" },
    { text:"please don't go",              emoji:"ðŸ§·", desc:"someone asks another to stay â€” with words or actions" },
    { text:"iâ€™m fine (they are not fine)", emoji:"ðŸ™‚â€â†”ï¸", desc:"character insists theyâ€™re okay while clearly falling apart" },
    { text:"held together by coffee",      emoji:"â˜•", desc:"theyâ€™re surviving on caffeine and stress alone" },
    { text:"touch-starved moment",         emoji:"ðŸ¤²", desc:"a hug or touch lingers because they really needed it" },
    { text:"jealousy they refuse to name", emoji:"ðŸ’š", desc:"a character gets jealous but denies it or misdirects it" },
    { text:"anger misfire",                emoji:"ðŸ’¢", desc:"they take anger meant for one thing out on someone else" },
    { text:"i don't do feelings",          emoji:"ðŸ§Š", desc:"emotionally unavailable character is forced into vulnerability" },
    { text:"guilt keeps them awake",       emoji:"ðŸŒ™ðŸ˜”", desc:"sleepless scene caused by regret, guilt, or anxiety" },
    { text:"smiling through it",           emoji:"ðŸ™‚",  desc:"faking a smile while obviously struggling inside" },
    { text:"overstimulation overload",     emoji:"ðŸ”Š",  desc:"too much noise, people, or pressure triggers shutdown or snap" },
    { text:"wrong person, right comfort",  emoji:"ðŸ«‚",  desc:"unexpected person gives the comfort they actually need" },
    { text:"i'm not like them",            emoji:"ðŸš·",  desc:"fear of becoming like a parent, ex, or role model slips out" },
    { text:"emotionally hungover",         emoji:"ðŸ¾ðŸ˜µ", desc:"the next day after a big emotional event feels heavy and raw" },
    { text:"panic in the parking lot",     emoji:"ðŸ…¿ï¸ðŸ’¥", desc:"anxiety or panic spike before/after a big event in a liminal space" },
    { text:"chose silence instead",        emoji:"ðŸ¤",  desc:"they almost tell the truth, then lie or change the subject" },
    { text:"i donâ€™t deserve you",          emoji:"ðŸ’”",  desc:"someone admits feeling unworthy of another person" },
    { text:"too much hope, too little proof", emoji:"â˜ï¸", desc:"they cling to a small sign things might get better" },
    { text:"fear dressed up as control",   emoji:"ðŸŽ›ï¸", desc:"controlling behavior is clearly masking fear or insecurity" },
    { text:"rage in the rearview",         emoji:"ðŸ”¥ðŸš—", desc:"they leave angry â€” the real emotions come out alone later" },
    { text:"soft apology, sharp truth",    emoji:"ðŸ©¹âš”ï¸", desc:"gentle apology that still forces someone to face a hard reality" },

    /* RELATIONSHIP PROMPTS (NO #10) */
    { text:"stolen hoodie",        emoji:"ðŸ§¥", desc:"wearing someone elseâ€™s clothes as comfort, claim, or habit" },
    { text:"accidental intimacy",  emoji:"ðŸ’˜", desc:"fixing hair, jewelry, or clothes â€” unexpectedly intimate" },
    { text:"we shouldnâ€™t do this", emoji:"ðŸ˜ˆ", desc:"they say it and still go through with it" },
    { text:"lingering goodbye",    emoji:"ðŸ•°ï¸", desc:"a goodbye hug, touch, or stare that goes on too long" },
    { text:"late-night call",      emoji:"ðŸ“žðŸŒ™", desc:"someone calls in the middle of the night with heavy vibes" },
    { text:"old feelings resurface", emoji:"ðŸ¥€", desc:"seeing someone from the past brings old emotions back" },
    { text:"soft betrayal",        emoji:"ðŸ—¡ï¸", desc:"they hurt someone â€œfor their own goodâ€ or to avoid pain" },
    { text:"almost confessed",     emoji:"ðŸ«£", desc:"they nearly admit feelings or truth, then swallow it" },
    { text:"tension that wonâ€™t die", emoji:"âš¡", desc:"ongoing unresolved tension that keeps returning" },

    /* SINGLE PEOPLE PROMPTS (KEEP ALL BUT 15,17) */
    { text:"i deserve something nice", emoji:"ðŸŽ", desc:"character treats themselves â€” big or small indulgence" },
    { text:"delulu but thriving",     emoji:"ðŸŒˆ", desc:"they lean into a fantasy about their life or crush" },
    { text:"self-care blackout",      emoji:"ðŸ§½ðŸ•¯ï¸", desc:"random burst of deep cleaning, planning, or self-care" },
    { text:"flirted for sport",       emoji:"ðŸŽ¯", desc:"they flirt purely for fun or chaos" },
    { text:"accidental hater",        emoji:"ðŸ˜’", desc:"they decide they don't like someone for no real reason" },
    { text:"ignored the red flag on purpose", emoji:"ðŸš©", desc:"they saw the warning signs and went in anyway" },

    /* FAMILY / CHILDHOOD PROMPTS (ALL) */
    { text:"old wound reopened",      emoji:"ðŸ©¸", desc:"a past family hurt resurfaces and still stings" },
    { text:"sibling chaos",           emoji:"ðŸ‘¯â€â™€ï¸", desc:"messy, loud, or chaotic moment with a sibling or sibling-figure" },
    { text:"found family moment",     emoji:"ðŸ ", desc:"they feel truly at home with people who aren't blood" },
    { text:"â€œjust like your mother/fatherâ€", emoji:"ðŸªž", desc:"comparison to a parent triggers pride, fear, or anger" },
    { text:"surprise visit from home", emoji:"ðŸ§³", desc:"family or someone from the past shows up unannounced" },
    { text:"childhood keepsake",      emoji:"ðŸ§¸", desc:"an object tied to their past appears or is held onto" },
    { text:"family secret slips out", emoji:"ðŸ«™ðŸ«¢", desc:"a comment reveals something the family tried to hide" },
    { text:"not ready to talk about it", emoji:"ðŸ§±", desc:"they shut down when family or history comes up" },

    /* FRIENDSHIP PROMPTS (NO #33) */
    { text:"bestie intervention",     emoji:"ðŸª‘ðŸ—£ï¸", desc:"friends team up to call someone out or hype them up to change" },
    { text:"hype squad moment",       emoji:"ðŸ“£", desc:"friends loudly cheer them on â€” outfit, date, life choice" },
    { text:"loyalty test",            emoji:"ðŸ•", desc:"a friend must choose a side or prove where their loyalty lies" },
    { text:"unexpected comfort",      emoji:"â˜ï¸", desc:"comfort comes from a friend they didnâ€™t expect" },
    { text:"friend breakup",          emoji:"ðŸ’”", desc:"two friends argue, drift apart, or end things" },
    { text:"secret shared over drinks", emoji:"ðŸ¥‚", desc:"someone reveals something big during a shared drink" },
    { text:"protective streak",       emoji:"ðŸ›¡ï¸", desc:"a friend gets protective â€” verbally or physically" },
    { text:"the groupchat decides",   emoji:"ðŸ“±ðŸ’¬", desc:"a big decision is influenced by the friend group" }
  ];

  /* map text -> desc for hover, including old saved cards */
  const promptDescMap = {};
  promptPool.forEach(p => { promptDescMap[p.text] = p.desc; });

  const grid = document.getElementById('grid');
  const statusEl = document.getElementById('status');
  const modal = document.getElementById('modal');
  const promptInput = document.getElementById('promptInput');
  const urlThread = document.getElementById('urlThread');
  const urlImage = document.getElementById('urlImage');
  const fileImage = document.getElementById('fileImage');
  const doneChk = document.getElementById('doneChk');
  const clearImage = document.getElementById('clearImage');
  const closeModal = document.getElementById('closeModal');
  const saveSquare = document.getElementById('saveSquare');

  const profileId = document.getElementById('profileId');
  const profilesList = document.getElementById('profilesList');
  const loadProfile = document.getElementById('loadProfile');
  const deleteProfile = document.getElementById('deleteProfile');
  const saveProfile = document.getElementById('saveProfile');
  const resetBoard = document.getElementById('resetBoard');
  const randomizeBoard = document.getElementById('randomizeBoard');

  const confettiEl = document.getElementById('confetti');

  let state = loadState() || makeDefault();
  let selectedIndex = null;
  let hadBingo = false;

  function currentKey(){
    const id = profileId.value.trim() || 'default';
    return PREFIX + id;
  }
  function saveStateData(){ localStorage.setItem(currentKey(), JSON.stringify(state)); }
  function loadState(key){
    const k = key || currentKey();
    try{
      const raw = localStorage.getItem(k);
      return raw ? JSON.parse(raw) : null;
    }catch{return null;}
  }

  function makeDefault(){
    const free = promptPool.find(p => p.text === "free space");
    const others = promptPool.filter(p => p.text !== "free space");
    const selected = others.slice(0, SIZE*SIZE - 1);
    let idx = 0;
    const arr = [];
    for(let i=0;i<SIZE*SIZE;i++){
      if(i === MID){
        arr.push({
          text: free.text,
          desc: free.desc,
          emoji: free.emoji || "",
          img: null,
          url: null,
          done: true
        });
      } else {
        const p = selected[idx++] || { text:"", desc:"", emoji:"" };
        arr.push({
          text: p.text,
          desc: p.desc,
          emoji: p.emoji || "",
          img: null,
          url: null,
          done: false
        });
      }
    }
    return arr;
  }

  function listProfiles(){
    profilesList.innerHTML = '';
    const keys = Object.keys(localStorage).filter(k=>k.startsWith(PREFIX));
    if(!keys.length){
      const opt=document.createElement('option');
      opt.value=''; opt.textContent='(none yet)';
      profilesList.appendChild(opt);
      return;
    }
    keys.forEach(k=>{
      const id=k.replace(PREFIX,'');
      const opt=document.createElement('option');
      opt.value=id; opt.textContent=id;
      profilesList.appendChild(opt);
    });
  }

  function winningSet(){
    const wins = new Set();
    const lines = [];

    for(let r=0;r<SIZE;r++)
      lines.push([r*SIZE,r*SIZE+1,r*SIZE+2,r*SIZE+3,r*SIZE+4]);
    for(let c=0;c<SIZE;c++)
      lines.push([c,c+SIZE,c+2*SIZE,c+3*SIZE,c+4*SIZE]);
    lines.push([0,6,12,18,24]);
    lines.push([4,8,12,16,20]);

    let any=false;
    for(const line of lines){
      if(line.every(i=>state[i].done)){
        any=true;
        line.forEach(i=>wins.add(i));
      }
    }

    if(any && !hadBingo){
      triggerCelebration();
    }
    hadBingo = any;

    if(any){
      statusEl.textContent = 'bingo â€” screenshot this card to redeem for points!';
    }else{
      statusEl.textContent = 'no bingo yet';
    }
    statusEl.classList.toggle('is-bingo', any);
    return wins;
  }

  function triggerCelebration(){
    playBeep();
    spawnConfetti();
  }

  function playBeep(){
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if(!AudioCtx) return;
      const ctx = new AudioCtx();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'triangle';
      osc.frequency.value = 880;
      gain.gain.setValueAtTime(0.0, ctx.currentTime);
      gain.gain.linearRampToValueAtTime(0.18, ctx.currentTime + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.25);
      osc.connect(gain).connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + 0.3);
    }catch(e){}
  }

  function spawnConfetti(){
    if(!confettiEl) return;
    confettiEl.innerHTML = '';
    const colors = [
      'rgba(80,120,210,1)',
      'rgba(245,130,100,1)',
      'rgba(255,215,135,1)',
      'rgba(127,255,212,1)',
      'rgba(255,255,255,0.9)'
    ];
    const count = 80;
    for(let i=0;i<count;i++){
      const piece = document.createElement('div');
      piece.className = 'ls-piece';
      const left = Math.random()*100;
      const delay = Math.random()*0.2;
      const duration = 1.5 + Math.random()*0.7;
      const color = colors[Math.floor(Math.random()*colors.length)];
      piece.style.left = left+'%';
      piece.style.setProperty('--x', ((Math.random()*40)-20)+'px');
      piece.style.background = color;
      piece.style.animationDuration = duration+'s';
      piece.style.animationDelay = delay+'s';
      confettiEl.appendChild(piece);
    }
    setTimeout(()=>{ confettiEl.innerHTML=''; }, 2500);
  }

  function render(){
    const winSet = winningSet();
    grid.innerHTML = '';

    state.forEach((cell, i)=>{
      const el = document.createElement('div');
      let cls = 'ls-cell';
      if(cell.done) cls += ' is-done';
      if(winSet.has(i)) cls += ' win';
      el.className = cls;

      const meta = promptPool.find(p => p.text === cell.text) || {};
      const emoji = cell.emoji || meta.emoji || "";
      const label = (emoji ? emoji + " " : "") + cell.text;
      const hoverDesc = cell.desc || promptDescMap[cell.text] || cell.text;

      if(cell.img){
        const img = document.createElement('div');
        img.className='ls-img';
        img.style.backgroundImage = `url("${cell.img}")`;
        el.appendChild(img);
      }

      const shade = document.createElement('div');
      shade.className='ls-shade';
      el.appendChild(shade);

      const badge = document.createElement('div');
      badge.className='ls-badge';
      badge.textContent = (i===MID ? 'FREE' : `#${i+1}`);
      el.appendChild(badge);

      const text = document.createElement('div');
      text.className='ls-text';
      text.textContent = label;
      el.appendChild(text);

      if(cell.url){
        const link = document.createElement('a');
        link.className='ls-link';
        link.href = cell.url;
        link.target='_blank';
        link.rel='noopener';
        link.textContent = cell.url.replace(/^https?:\/\//,'').slice(0,30) + (cell.url.length>30?'â€¦':'');
        el.appendChild(link);
      }

      const tip = document.createElement('div');
      tip.className = 'ls-tip';
      tip.textContent = hoverDesc;
      el.appendChild(tip);

      const done = document.createElement('div');
      done.className='ls-done';
      done.innerHTML = "<div class='ls-check'>âœ”</div>";
      el.appendChild(done);

      // Left click = open editor
      el.addEventListener('click', ()=>{
        openModal(i);
      });

      grid.appendChild(el);
    });
  }

  function openModal(i){
    selectedIndex = i;
    const cell = state[i];
    promptInput.value = cell.text;
    urlThread.value = cell.url || '';
    urlImage.value = '';
    fileImage.value = '';
    doneChk.checked = !!cell.done;
    modal.classList.add('show');
  }
  function closeEditor(){
    modal.classList.remove('show');
    selectedIndex = null;
  }

  async function handleSaveSquare(){
    if(selectedIndex===null) return;
    const cell = state[selectedIndex];
    cell.url = urlThread.value.trim() || null;

    const imgUrl = urlImage.value.trim();
    if(imgUrl) cell.img = imgUrl;

    if(fileImage.files && fileImage.files[0]){
      const fileImageData = await fileToDataURL(fileImage.files[0]);
      cell.img = fileImageData;
    }

    cell.done = doneChk.checked || (selectedIndex===MID);
    saveStateData();
    render();
    closeEditor();
  }

  function fileToDataURL(file){
    return new Promise((resolve,reject)=>{
      const fr=new FileReader();
      fr.onload=()=>resolve(fr.result);
      fr.onerror=reject;
      fr.readAsDataURL(file);
    });
  }

  saveSquare.addEventListener('click', handleSaveSquare);
  clearImage.addEventListener('click', ()=>{
    if(selectedIndex===null) return;
    state[selectedIndex].img = null;
    saveStateData();
    render();
  });
  closeModal.addEventListener('click', closeEditor);

  saveProfile.addEventListener('click', ()=>{
    saveStateData();
    listProfiles();
  });

  loadProfile.addEventListener('click', ()=>{
    const id = profilesList.value;
    if(!id) return;
    profileId.value = id;
    const loaded = loadState(PREFIX+id);
    state = loaded || makeDefault();

    // backfill descriptions + emojis for older saves
    state = state.map(cell => {
      const meta = promptPool.find(p => p.text === cell.text) || {};
      return {
        text: cell.text,
        desc: cell.desc || meta.desc || promptDescMap[cell.text] || "",
        emoji: cell.emoji || meta.emoji || "",
        img: cell.img || null,
        url: cell.url || null,
        done: !!cell.done
      };
    });

    saveStateData();
    render();
  });

  deleteProfile.addEventListener('click', ()=>{
    const id = profilesList.value;
    if(!id) return;
    if(!confirm(`Delete saved profile "${id}"?`)) return;
    localStorage.removeItem(PREFIX+id);
    if(profileId.value === id) profileId.value='';
    listProfiles();
    state = makeDefault();
    saveStateData();
    render();
  });

  resetBoard.addEventListener('click', ()=>{
    if(!confirm('Reset board for this profile?')) return;
    state = makeDefault();
    saveStateData();
    render();
  });

  randomizeBoard.addEventListener('click', ()=>{
    if(!confirm('Randomize prompts for this profile? This will clear links, images, and completion.')) return;
    randomizePrompts();
  });

  function randomizePrompts(){
    const free = promptPool.find(p => p.text === "free space");
    const others = promptPool.filter(p => p.text !== "free space");

    const shuffled = others.slice();
    for(let i = shuffled.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }

    let idx = 0;
    const arr = [];
    for(let i=0;i<SIZE*SIZE;i++){
      if(i === MID){
        arr.push({
          text: free.text,
          desc: free.desc,
          emoji: free.emoji || "",
          img: null,
          url: null,
          done: true
        });
      } else {
        const p = shuffled[idx++] || { text:"", desc:"", emoji:"" };
        arr.push({
          text: p.text,
          desc: p.desc,
          emoji: p.emoji || "",
          img: null,
          url: null,
          done: false
        });
      }
    }
    state = arr;
    saveStateData();
    render();
  }

  listProfiles();
  render();
})();
</script>
</body>
</html>
